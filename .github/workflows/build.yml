name: Build Static BEAM

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-static-beam:
    name: Build Static Erlang/OTP (Alpine/musl)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Static Erlang
        run: |
          docker build --target erlang -o ./static-erlang .

      - name: Verify Static Linking
        run: |
          echo "=== Checking beam.smp ==="
          BEAM_SMP=$(find static-erlang -name "beam.smp" -type f | head -1)
          if [ -n "$BEAM_SMP" ]; then
            file "$BEAM_SMP"
            ldd "$BEAM_SMP" 2>&1 || echo "Not a dynamic executable (good!)"
          fi

          echo ""
          echo "=== Checking erlexec ==="
          ERLEXEC=$(find static-erlang -name "erlexec" -type f | head -1)
          if [ -n "$ERLEXEC" ]; then
            file "$ERLEXEC"
            ldd "$ERLEXEC" 2>&1 || echo "Not a dynamic executable (good!)"
          fi

      - name: Package Erlang
        run: |
          mkdir -p dist
          mv static-erlang dist/
          cd dist && tar -czvf static-erlang-linux-x86_64.tar.gz static-erlang

      - name: Upload Erlang Artifact
        uses: actions/upload-artifact@v4
        with:
          name: static-erlang-linux-x86_64
          path: dist/static-erlang-*.tar.gz
          retention-days: 7

  docker-test:
    name: Test Portability
    runs-on: ubuntu-latest
    needs: build-static-beam
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Erlang Artifact
        uses: actions/download-artifact@v4
        with:
          name: static-erlang-linux-x86_64
          path: dist

      - name: Extract Artifact
        run: |
          cd dist
          tar -xzvf static-erlang-*.tar.gz
          mv static-erlang ../static-beam

      - name: Test on Debian
        run: |
          docker run --rm -v $(pwd)/static-beam:/opt/erlang debian:bookworm-slim \
            /opt/erlang/bin/erl -noshell -eval 'io:format("Erlang ~s on Debian~n", [erlang:system_info(otp_release)]), halt().'

      - name: Test on Alpine
        run: |
          docker run --rm -v $(pwd)/static-beam:/opt/erlang alpine:3.21 \
            /opt/erlang/bin/erl -noshell -eval 'io:format("Erlang ~s on Alpine~n", [erlang:system_info(otp_release)]), halt().'

      - name: Test on BusyBox
        run: |
          docker run --rm -v $(pwd)/static-beam:/opt/erlang busybox:musl \
            /opt/erlang/bin/erl -noshell -eval 'io:format("Erlang ~s on BusyBox~n", [erlang:system_info(otp_release)]), halt().'

      - name: Test Crypto and SSL
        run: |
          docker run --rm -v $(pwd)/static-beam:/opt/erlang alpine:3.21 \
            /opt/erlang/bin/erl -noshell -eval '
              application:start(crypto),
              io:format("Crypto: OK~n"),
              application:start(asn1),
              application:start(public_key),
              application:start(ssl),
              io:format("SSL: OK~n"),
              halt().
            '
