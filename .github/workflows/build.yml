name: Build Static BEAM

on:
  push:
    branches: [main]
    tags: ['OTP-*']
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: Build Static Erlang/OTP (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
            platform: linux/amd64
          - arch: arm64
            runner: ubuntu-24.04-arm
            platform: linux/arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Static Erlang
        run: |
          docker build --target erlang -o ./static-erlang .

      - name: Verify Static Linking
        run: |
          echo "=== Checking beam.smp ==="
          BEAM_SMP=$(find static-erlang -name "beam.smp" -type f | head -1)
          if [ -n "$BEAM_SMP" ]; then
            file "$BEAM_SMP"
            ldd "$BEAM_SMP" 2>&1 || echo "Not a dynamic executable (good!)"
          fi

          echo ""
          echo "=== Checking erlexec ==="
          ERLEXEC=$(find static-erlang -name "erlexec" -type f | head -1)
          if [ -n "$ERLEXEC" ]; then
            file "$ERLEXEC"
            ldd "$ERLEXEC" 2>&1 || echo "Not a dynamic executable (good!)"
          fi

      - name: Get OTP Version
        id: otp_version
        run: |
          OTP_VERSION=$(grep "^ARG OTP_VERSION=" Dockerfile | sed 's/ARG OTP_VERSION=//')
          echo "version=${OTP_VERSION}" >> $GITHUB_OUTPUT

      - name: Collect Build Info
        id: build_info
        run: |
          # Run build info collection inside Alpine container (same environment as build)
          docker run --rm -v $(pwd)/static-erlang:/opt/erlang alpine:3.21 sh -c '
            export PATH="/opt/erlang/bin:$PATH"

            echo "otp_release=$(/opt/erlang/bin/erl -noshell -eval "io:format(\"~s\", [erlang:system_info(otp_release)]), halt().")"
            echo "erts_version=$(/opt/erlang/bin/erl -noshell -eval "io:format(\"~s\", [erlang:system_info(version)]), halt().")"
            echo "system_arch=$(/opt/erlang/bin/erl -noshell -eval "io:format(\"~s\", [erlang:system_info(system_architecture)]), halt().")"
            echo "word_size=$(/opt/erlang/bin/erl -noshell -eval "io:format(\"~p\", [erlang:system_info(wordsize) * 8]), halt().")"

            # Crypto info
            crypto_info=$(/opt/erlang/bin/erl -noshell -eval "
              application:start(crypto),
              Algos = crypto:supports(),
              HashAlgos = proplists:get_value(hashs, Algos, []),
              CipherAlgos = proplists:get_value(ciphers, Algos, []),
              PKAlgos = proplists:get_value(public_keys, Algos, []),
              io:format(\"~p hash algorithms, ~p ciphers, ~p public key algorithms\", [length(HashAlgos), length(CipherAlgos), length(PKAlgos)]),
              halt()." 2>/dev/null || echo "unavailable")
            echo "crypto_info=$crypto_info"

            # SSL versions
            ssl_versions=$(/opt/erlang/bin/erl -noshell -eval "
              application:start(crypto),
              application:start(asn1),
              application:start(public_key),
              application:start(ssl),
              Versions = ssl:versions(),
              Supported = proplists:get_value(supported, Versions, []),
              io:format(\"~p\", [Supported]),
              halt()." 2>/dev/null || echo "[]")
            echo "ssl_versions=$ssl_versions"

            # Applications
            apps=$(/opt/erlang/bin/erl -noshell -eval "
              {ok, Apps} = file:list_dir(code:lib_dir()),
              Names = lists:sort([begin [N|_] = string:split(A, \"-\"), N end || A <- Apps]),
              io:format(\"~s\", [string:join(Names, \", \")]),
              halt().")
            echo "applications=$apps"
          ' | tee /tmp/build_info.txt

          # Parse output to GitHub outputs
          grep "^otp_release=" /tmp/build_info.txt | cut -d= -f2 | xargs -I{} echo "otp_release={}" >> $GITHUB_OUTPUT
          grep "^erts_version=" /tmp/build_info.txt | cut -d= -f2 | xargs -I{} echo "erts_version={}" >> $GITHUB_OUTPUT
          grep "^system_arch=" /tmp/build_info.txt | cut -d= -f2 | xargs -I{} echo "system_arch={}" >> $GITHUB_OUTPUT
          grep "^word_size=" /tmp/build_info.txt | cut -d= -f2 | xargs -I{} echo "word_size={}" >> $GITHUB_OUTPUT
          grep "^crypto_info=" /tmp/build_info.txt | cut -d= -f2- | xargs -I{} echo "crypto_info={}" >> $GITHUB_OUTPUT
          grep "^ssl_versions=" /tmp/build_info.txt | cut -d= -f2- | xargs -I{} echo "ssl_versions={}" >> $GITHUB_OUTPUT
          grep "^applications=" /tmp/build_info.txt | cut -d= -f2- | xargs -I{} echo "applications={}" >> $GITHUB_OUTPUT
          echo "nif_modules=[crypto, asn1rt_nif, prim_buffer, prim_file, zlib]" >> $GITHUB_OUTPUT

      - name: Generate Build Info File
        run: |
          mkdir -p dist
          cat > dist/BUILD_INFO_${{ matrix.arch }}.md << 'EOF'
          ## Build Information (${{ matrix.arch }})

          | Property | Value |
          |----------|-------|
          | OTP Release | ${{ steps.build_info.outputs.otp_release }} |
          | ERTS Version | ${{ steps.build_info.outputs.erts_version }} |
          | Architecture | ${{ steps.build_info.outputs.system_arch }} |
          | Word Size | ${{ steps.build_info.outputs.word_size }}-bit |
          | Build Type | Static (musl libc) |

          ### Crypto Support
          ${{ steps.build_info.outputs.crypto_info }}

          ### SSL/TLS Versions
          ${{ steps.build_info.outputs.ssl_versions }}

          ### Included NIF Modules
          ${{ steps.build_info.outputs.nif_modules }}

          ### Included Applications
          ${{ steps.build_info.outputs.applications }}
          EOF

          cat dist/BUILD_INFO_${{ matrix.arch }}.md

      - name: Package Erlang
        run: |
          mv static-erlang dist/
          cd dist && tar -czvf static-erlang-otp-${{ steps.otp_version.outputs.version }}-linux-${{ matrix.arch }}.tar.gz static-erlang

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: static-erlang-linux-${{ matrix.arch }}
          path: |
            dist/static-erlang-*.tar.gz
            dist/BUILD_INFO_*.md
          retention-days: 7

  test:
    name: Test Portability (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    needs: build
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: static-erlang-linux-${{ matrix.arch }}
          path: dist

      - name: Extract Artifact
        run: |
          cd dist
          tar -xzvf static-erlang-*.tar.gz
          mv static-erlang ../static-beam

      - name: Test on Debian
        run: |
          docker run --rm -v $(pwd)/static-beam:/opt/erlang debian:bookworm-slim \
            /opt/erlang/bin/erl -noshell -eval 'io:format("Erlang ~s on Debian~n", [erlang:system_info(otp_release)]), halt().'

      - name: Test on Alpine
        run: |
          docker run --rm -v $(pwd)/static-beam:/opt/erlang alpine:3.21 \
            /opt/erlang/bin/erl -noshell -eval 'io:format("Erlang ~s on Alpine~n", [erlang:system_info(otp_release)]), halt().'

      - name: Test on BusyBox
        run: |
          docker run --rm -v $(pwd)/static-beam:/opt/erlang busybox:musl \
            /opt/erlang/bin/erl -noshell -eval 'io:format("Erlang ~s on BusyBox~n", [erlang:system_info(otp_release)]), halt().'

      - name: Test Crypto and SSL
        run: |
          docker run --rm -v $(pwd)/static-beam:/opt/erlang alpine:3.21 \
            /opt/erlang/bin/erl -noshell -eval '
              application:start(crypto),
              io:format("Crypto: OK~n"),
              application:start(asn1),
              application:start(public_key),
              application:start(ssl),
              io:format("SSL: OK~n"),
              halt().
            '

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/OTP-')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download amd64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: static-erlang-linux-amd64
          path: dist/amd64

      - name: Download arm64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: static-erlang-linux-arm64
          path: dist/arm64

      - name: Get Build Configuration
        id: build_config
        run: |
          # Extract OTP version from tag
          OTP_VERSION=${GITHUB_REF#refs/tags/OTP-}
          echo "otp_version=${OTP_VERSION}" >> $GITHUB_OUTPUT

          # Get Dockerfile build args
          ELIXIR_VERSION=$(grep "^ARG ELIXIR_VERSION=" Dockerfile | sed 's/ARG ELIXIR_VERSION=//')
          echo "elixir_version=${ELIXIR_VERSION}" >> $GITHUB_OUTPUT

          ALPINE_VERSION=$(grep "FROM alpine:" Dockerfile | head -1 | sed 's/FROM alpine://' | sed 's/ .*//')
          echo "alpine_version=${ALPINE_VERSION}" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # Static Erlang/OTP ${{ steps.build_config.outputs.otp_version }}

          Fully static Erlang/OTP binaries built with Alpine Linux and musl libc. Zero dynamic dependencies - runs on any Linux distribution.

          ## Build Configuration

          | Parameter | Value |
          |-----------|-------|
          | OTP Version | ${{ steps.build_config.outputs.otp_version }} |
          | Alpine Version | ${{ steps.build_config.outputs.alpine_version }} |
          | C Library | musl (static) |
          | SSL Library | OpenSSL (static) |
          | Build Flags | `LDFLAGS="-static"` |
          | Configure Options | `--enable-static-nifs --enable-static-drivers` |

          ## Included Features

          - **Crypto**: Full OpenSSL crypto support (statically linked)
          - **SSL/TLS**: Complete SSL application with TLS 1.2/1.3 support
          - **NIFs**: crypto, asn1rt_nif, prim_buffer, prim_file, zlib (statically linked)

          ## Architectures

          | Architecture | File | Runner |
          |--------------|------|--------|
          | x86_64 (Intel/AMD) | `static-erlang-otp-${{ steps.build_config.outputs.otp_version }}-linux-amd64.tar.gz` | Servers, Desktop |
          | arm64 (Apple Silicon, Graviton) | `static-erlang-otp-${{ steps.build_config.outputs.otp_version }}-linux-arm64.tar.gz` | AWS Graviton, Apple M-series |

          ## Quick Start

          ```bash
          # Download (choose your architecture)
          ARCH="amd64"  # or "arm64"
          curl -LO "https://github.com/${{ github.repository }}/releases/download/OTP-${{ steps.build_config.outputs.otp_version }}/static-erlang-otp-${{ steps.build_config.outputs.otp_version }}-linux-${ARCH}.tar.gz"

          # Extract to /opt/erlang (required path)
          sudo mkdir -p /opt/erlang
          sudo tar -xzf static-erlang-otp-${{ steps.build_config.outputs.otp_version }}-linux-${ARCH}.tar.gz -C /opt/erlang --strip-components=1

          # Verify
          /opt/erlang/bin/erl -noshell -eval 'io:format("OTP ~s~n", [erlang:system_info(otp_release)]), halt().'
          ```

          ## Elixir Mix Release Usage

          ```elixir
          # mix.exs
          def project do
            [
              releases: [
                my_app: [
                  include_erts: "/opt/erlang/lib/erlang"
                ]
              ]
            ]
          end
          ```

          ## Verification

          ```bash
          # Confirm static linking
          ldd /opt/erlang/lib/erlang/erts-*/bin/beam.smp
          # Output: not a dynamic executable

          # Test crypto
          /opt/erlang/bin/erl -noshell -eval 'crypto:start(), io:format("Crypto OK~n"), halt().'

          # Test SSL
          /opt/erlang/bin/erl -noshell -eval 'ssl:start(), io:format("SSL OK~n"), halt().'
          ```

          ## Tested On

          - Debian Bookworm
          - Alpine 3.21
          - BusyBox (musl)
          - scratch containers
          EOF

          cat RELEASE_NOTES.md

      - name: Prepare Release Assets
        run: |
          mkdir -p release
          cp dist/amd64/static-erlang-*.tar.gz release/
          cp dist/arm64/static-erlang-*.tar.gz release/
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.tar.gz
          body_path: RELEASE_NOTES.md
