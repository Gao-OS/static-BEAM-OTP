name: Build Static BEAM

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_elixir:
        description: 'Build Elixir (includes Erlang)'
        required: false
        default: false
        type: boolean

env:
  NIXPKGS_ALLOW_UNFREE: 1

jobs:
  build-erlang:
    name: Build Static Erlang/OTP
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: devenv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Build Static Erlang
        run: |
          nix-build nix/static-erlang.nix -o result-erlang

      - name: Verify Static Linking
        run: |
          echo "=== Checking beam.smp ==="
          BEAM_SMP=$(find result-erlang -name "beam.smp" -type f | head -1)
          if [ -n "$BEAM_SMP" ]; then
            file "$BEAM_SMP"
            ldd "$BEAM_SMP" 2>&1 || echo "Not a dynamic executable (good!)"
          fi

          echo ""
          echo "=== Checking erlexec ==="
          ERLEXEC=$(find result-erlang -name "erlexec" -type f | head -1)
          if [ -n "$ERLEXEC" ]; then
            file "$ERLEXEC"
            ldd "$ERLEXEC" 2>&1 || echo "Not a dynamic executable (good!)"
          fi

      - name: Test Erlang
        run: |
          result-erlang/bin/erl -noshell -eval '
            io:format("OTP Release: ~s~n", [erlang:system_info(otp_release)]),
            io:format("ERTS Version: ~s~n", [erlang:system_info(version)]),
            io:format("Architecture: ~s~n", [erlang:system_info(system_architecture)]),
            halt().
          '

      - name: Package Erlang
        run: |
          mkdir -p dist
          cp -rL result-erlang dist/static-erlang
          cd dist && tar -czvf static-erlang-${{ github.ref_name }}-linux-x86_64.tar.gz static-erlang

      - name: Upload Erlang Artifact
        uses: actions/upload-artifact@v4
        with:
          name: static-erlang-linux-x86_64
          path: dist/static-erlang-*.tar.gz
          retention-days: 7

  build-elixir:
    name: Build Static Elixir
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_elixir == 'true' || startsWith(github.ref, 'refs/tags/') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: devenv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Build Static Elixir
        run: |
          nix-build nix/static-elixir.nix -o result-elixir

      - name: Test Elixir
        run: |
          result-elixir/bin/elixir --version

      - name: Package Elixir
        run: |
          mkdir -p dist
          cp -rL result-elixir dist/static-elixir
          cd dist && tar -czvf static-elixir-${{ github.ref_name }}-linux-x86_64.tar.gz static-elixir

      - name: Upload Elixir Artifact
        uses: actions/upload-artifact@v4
        with:
          name: static-elixir-linux-x86_64
          path: dist/static-elixir-*.tar.gz
          retention-days: 7

  docker-test:
    name: Test in Docker
    runs-on: ubuntu-latest
    needs: build-erlang
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Erlang Artifact
        uses: actions/download-artifact@v4
        with:
          name: static-erlang-linux-x86_64
          path: dist

      - name: Extract Artifact
        run: |
          cd dist
          tar -xzvf static-erlang-*.tar.gz
          mv static-erlang ../static-beam

      - name: Test on Debian
        run: |
          docker run --rm -v $(pwd)/static-beam:/opt/beam debian:bookworm-slim \
            /opt/beam/bin/erl -noshell -eval 'io:format("Erlang ~s on Debian~n", [erlang:system_info(otp_release)]), halt().'

      - name: Test on Alpine
        run: |
          docker run --rm -v $(pwd)/static-beam:/opt/beam alpine:3.19 \
            /opt/beam/bin/erl -noshell -eval 'io:format("Erlang ~s on Alpine~n", [erlang:system_info(otp_release)]), halt().'

      - name: Test on BusyBox
        run: |
          docker run --rm -v $(pwd)/static-beam:/opt/beam busybox:musl \
            /opt/beam/bin/erl -noshell -eval 'io:format("Erlang ~s on BusyBox~n", [erlang:system_info(otp_release)]), halt().'

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-erlang, docker-test]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download Erlang Artifact
        uses: actions/download-artifact@v4
        with:
          name: static-erlang-linux-x86_64
          path: dist

      - name: Download Elixir Artifact
        uses: actions/download-artifact@v4
        with:
          name: static-elixir-linux-x86_64
          path: dist
        continue-on-error: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.tar.gz
          generate_release_notes: true
